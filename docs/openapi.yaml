openapi: 3.0.3
info:
  title: Card Game API
  version: 1.0.0
  description: API specification for Auth, Player, and Game services.

servers:
  - url: https://localhost:8443
    description: API Gateway (HTTPS)
  - url: http://localhost:8001
    description: Auth Service
  - url: http://localhost:8002
    description: Player Service
  - url: http://localhost:8003
    description: Game Service

paths:

  ###############################################
  # AUTH SERVICE (PORT 8001)
  ###############################################

  /auth/register:
    post:
      summary: Register new user
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                email:
                  type: string
                password:
                  type: string
      responses:
        "201":
          description: User registered

  /auth/login:
    post:
      summary: Login and obtain JWT
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        "200":
          description: JWT token returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string

  /auth/refresh:
    post:
      summary: Refresh JWT token
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
      responses:
        "200":
          description: New tokens returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string

  /auth/logout:
    post:
      summary: Logout and blacklist token
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
      responses:
        "200":
          description: Logged out successfully

  /auth/validate:
    get:
      summary: Validate JWT token
      tags: [Auth]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Token is valid

  /auth/health:
    get:
      summary: Health check
      tags: [Auth]
      responses:
        "200":
          description: Alive

  ###############################################
  # PLAYER SERVICE (PORT 8002)
  ###############################################

  /health:
    get:
      summary: Health check
      tags: [Player]
      responses:
        "200":
          description: Service OK

  /internal/players:
    post:
      summary: Sync player profile internally
      tags: [Player]
      security:
        - internalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                external_id:
                  type: string
                username:
                  type: string
                  nullable: true
      responses:
        "200":
          description: Profile synced
        "201":
          description: Profile created

  /players:
    post:
      summary: Create or update my profile
      tags: [Player]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  nullable: true
      responses:
        "200":
          description: Profile updated
        "201":
          description: Profile created

  /players/me:
    get:
      summary: Get my profile
      tags: [Player]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Profile
        "404":
          description: Player not found

  /matches:
    post:
      summary: Create match record (for statistics)
      tags: [Player]
      security:
        - internalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player1_external_id
                - player2_external_id
                - player1_score
                - player2_score
                - external_match_id
              properties:
                player1_external_id:
                  type: string
                player2_external_id:
                  type: string
                winner_external_id:
                  type: string
                  nullable: true
                player1_score:
                  type: integer
                player2_score:
                  type: integer
                external_match_id:
                  type: string
                  description: Idempotency key.
                moves_log:
                  type: string
                  nullable: true
                  description: Optional pre-formatted match moves log.
                turns:
                  type: array
                  items:
                    type: object
                    properties:
                      turn_number:
                        type: integer
                      player1_card_name:
                        type: string
                      player2_card_name:
                        type: string
                      winner_external_id:
                        type: string
                        nullable: true
      responses:
        "201":
          description: Match record created

  /players/{player_id}/matches:
    get:
      summary: Player match history (public)
      tags: [Player]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of matches

  /players/{player_id}/matches/{match_id}:
    get:
      summary: Get match details (public)
      tags: [Player]
      parameters:
        - name: player_id
          in: path
          required: true
          schema:
            type: string
        - name: match_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Match details

  /leaderboard:
    get:
      summary: Get leaderboard
      tags: [Player]
      responses:
        "200":
          description: Leaderboard list

  ###############################################
  # GAME SERVICE (PORT 8003)
  ###############################################

  /matches:
    post:
      summary: Create new match
      tags: [Game]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player1_id
                - player2_id
              properties:
                player1_id:
                  type: string
                player2_id:
                  type: string
      responses:
        "200":
          description: Match created
          content:
            application/json:
              schema:
                type: object
                properties:
                  match_id:
                    type: string
                  player_id:
                    type: string
                  hand:
                    type: array
                    items:
                      type: object
                  status:
                    type: string

  /matches/{match_id}/move:
    post:
      summary: Submit a card move
      tags: [Game]
      security:
        - bearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player_id
                - card_index
              properties:
                player_id:
                  type: string
                card_index:
                  type: integer
      responses:
        "200":
          description: Move accepted
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      status:
                        type: string
                        enum: ["waiting_for_opponent"]
                  - type: object
                    properties:
                      round:
                        type: integer
                      winner:
                        type: string
                        nullable: true
                      reason:
                        type: string
                      points_p1:
                        type: integer
                      points_p2:
                        type: integer
                      match_finished:
                        type: boolean
                      match_winner:
                        type: string
                        nullable: true

  /matches/{match_id}:
    get:
      summary: Get match state
      tags: [Game]
      security:
        - bearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
        - name: player_id
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Match state retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  match_id:
                    type: string
                  status:
                    type: string
                  player1_id:
                    type: string
                  player2_id:
                    type: string
                  current_round:
                    type: integer
                  player1_score:
                    type: integer
                  player2_score:
                    type: integer
                  winner:
                    type: string
                    nullable: true
                  hand:
                    type: array
                    items:
                      type: object

  /matches/active:
    get:
      summary: Get active matches for user
      tags: [Game]
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of active matches

  /matches/{match_id}/surrender:
    post:
      summary: Surrender match
      tags: [Game]
      security:
        - bearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Match surrendered

  /cards:
    get:
      summary: Get deck gallery (SVG)
      tags: [Game]
      responses:
        "200":
          description: SVG gallery
          content:
            image/svg+xml:
              schema:
                type: string

  /cards/{card_id}:
    get:
      summary: Get card detail (SVG)
      tags: [Game]
      parameters:
        - name: card_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: SVG card detail
          content:
            image/svg+xml:
              schema:
                type: string

  /matches/{match_id}/hand:
    get:
      summary: Get player hand (SVG)
      tags: [Game]
      security:
        - bearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: SVG hand visualization
          content:
            image/svg+xml:
              schema:
                type: string

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    internalApiKey:
      type: apiKey
      in: header
      name: X-Internal-Api-Key
