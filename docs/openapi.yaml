openapi: 3.0.3
info:
  title: Tri-Duel Game API
  version: 1.0.0
  description: Complete API specification for Auth, Player, and Game microservices. Use with API Gateway as main entry point.
  contact:
    name: Development Team
  license:
    name: MIT

servers:
  - url: https://localhost:8443
    description: API Gateway (Main Entry Point)
  - url: https://localhost:8001
    description: Auth Service (Internal)
  - url: https://localhost:8002
    description: Player Service (Internal)
  - url: https://localhost:8003
    description: Game Service (Internal)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login endpoint
    internalApiKey:
      type: apiKey
      in: header
      name: X-Internal-Api-Key
      description: Internal service-to-service API key

  schemas:
    Error:
      type: object
      properties:
        detail:
          type: string

    UserOut:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
        role:
          type: string
          enum: [user, admin]
        created_at:
          type: string
          format: date-time
        is_active:
          type: boolean

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        token_type:
          type: string
          default: bearer

    PlayerProfileOut:
      type: object
      properties:
        id:
          type: integer
        external_id:
          type: string
        username:
          type: string
        wins:
          type: integer
        losses:
          type: integer
        rating:
          type: integer

    MatchSummaryOut:
      type: object
      properties:
        id:
          type: integer
        external_match_id:
          type: string
        player1_external_id:
          type: string
        player2_external_id:
          type: string
        winner_external_id:
          type: string
          nullable: true
        player1_score:
          type: integer
        player2_score:
          type: integer
        created_at:
          type: string
          format: date-time

    Card:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        category:
          type: string
          enum: [Rock, Paper, Scissors]
        power_level:
          type: integer
        rarity:
          type: string
          enum: [Common, Uncommon, Rare, Legendary]

    CreateMatchResponse:
      type: object
      properties:
        match_id:
          type: string
        player_id:
          type: string
        hand:
          type: array
          items:
            $ref: '#/components/schemas/Card'
        status:
          type: string

    MatchStateResponse:
      type: object
      properties:
        match_id:
          type: string
        player1_id:
          type: string
        player2_id:
          type: string
        player1_hp:
          type: integer
        player2_hp:
          type: integer
        current_turn:
          type: string
        status:
          type: string
        round_number:
          type: integer

    MoveResultSchema:
      type: object
      properties:
        status:
          type: string
        round_winner:
          type: string
          nullable: true
        player1_hp:
          type: integer
        player2_hp:
          type: integer
        match_result:
          type: string
          nullable: true
          enum: [player1_wins, player2_wins, draw]

    LeaderboardEntry:
      type: object
      properties:
        external_id:
          type: string
        username:
          type: string
        wins:
          type: integer
        matches:
          type: integer

paths:

  ###############################################
  # AUTH SERVICE ENDPOINTS
  ###############################################

  /auth/register:
    post:
      summary: Register new user
      tags: [Auth]
      operationId: register_user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - password
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 20
                  pattern: '^[a-zA-Z0-9_-]+$'
                  example: "player_123"
                email:
                  type: string
                  format: email
                  example: "user@example.com"
                password:
                  type: string
                  minLength: 8
                  example: "SecurePass123"
      responses:
        "201":
          description: User successfully registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserOut'
        "400":
          description: Invalid input or user already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      summary: Login and obtain JWT tokens
      tags: [Auth]
      operationId: login_user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        "200":
          description: Successfully logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        "400":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/refresh:
    post:
      summary: Refresh access token using refresh token
      tags: [Auth]
      operationId: refresh_access_token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        "200":
          description: New access token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        "401":
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/validate:
    get:
      summary: Validate JWT token
      tags: [Auth]
      operationId: validate_token
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Token is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: integer
                  username:
                    type: string
        "401":
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      summary: Logout and blacklist token
      tags: [Auth]
      operationId: logout_user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
      responses:
        "200":
          description: Logged out successfully
        "400":
          description: Token already blacklisted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/health:
    get:
      summary: Auth service health check
      tags: [Auth]
      operationId: auth_health
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"

  ###############################################
  # PLAYER SERVICE ENDPOINTS
  ###############################################

  /player/players:
    post:
      summary: Create or update player profile
      tags: [Player]
      operationId: create_player_profile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  nullable: true
      responses:
        "201":
          description: Player profile created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlayerProfileOut'
        "200":
          description: Player profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlayerProfileOut'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: Player not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /player/players/me:
    get:
      summary: Get authenticated player's profile
      tags: [Player]
      operationId: get_my_profile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current player's profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlayerProfileOut'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: Player profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /player/players/{player_external_id}/matches:
    get:
      summary: Get match history for a player
      tags: [Player]
      operationId: list_player_matches
      parameters:
        - name: player_external_id
          in: path
          required: true
          schema:
            type: string
          description: Player's external ID (username)
      responses:
        "200":
          description: List of player's matches
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MatchSummaryOut'
        "404":
          description: Player not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /player/players/{player_external_id}/matches/{match_id}:
    get:
      summary: Get detailed match information
      tags: [Player]
      operationId: get_match_detail
      parameters:
        - name: player_external_id
          in: path
          required: true
          schema:
            type: string
        - name: match_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Match details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchSummaryOut'
        "404":
          description: Match or player not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /player/matches:
    post:
      summary: Record match result (Internal)
      tags: [Player]
      operationId: create_match_record
      security:
        - internalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player1_external_id
                - player2_external_id
                - player1_score
                - player2_score
                - external_match_id
              properties:
                player1_external_id:
                  type: string
                player2_external_id:
                  type: string
                winner_external_id:
                  type: string
                  nullable: true
                player1_score:
                  type: integer
                player2_score:
                  type: integer
                external_match_id:
                  type: string
                  description: Unique match identifier for idempotency
                moves_log:
                  type: string
                  nullable: true
                turns:
                  type: array
                  items:
                    type: object
                    properties:
                      turn_number:
                        type: integer
                      player1_card_name:
                        type: string
                      player2_card_name:
                        type: string
                      winner_external_id:
                        type: string
                        nullable: true
      responses:
        "201":
          description: Match record created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          description: Unauthorized (invalid API key)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /player/leaderboard:
    get:
      summary: Get global leaderboard
      tags: [Player]
      operationId: get_leaderboard
      description: Returns sorted list of players by wins and matches played
      responses:
        "200":
          description: Leaderboard list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LeaderboardEntry'

  /player/health:
    get:
      summary: Player service health check
      tags: [Player]
      operationId: player_health
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"

  ###############################################
  # GAME SERVICE ENDPOINTS
  ###############################################

  /game/matches:
    post:
      summary: Create a new match
      tags: [Game]
      operationId: create_match
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player1_id
                - player2_id
              properties:
                player1_id:
                  type: string
                  description: Username of player 1 (must match authenticated user)
                player2_id:
                  type: string
                  description: Username of player 2 (opponent)
      responses:
        "200":
          description: Match created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateMatchResponse'
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "403":
          description: Cannot create match as other player
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /game/matches/{match_id}:
    get:
      summary: Get match state for authenticated player
      tags: [Game]
      operationId: get_match_state
      security:
        - bearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
        - name: player_id
          in: query
          required: true
          schema:
            type: string
          description: Player ID (must match authenticated user)
      responses:
        "200":
          description: Match state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchStateResponse'
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "403":
          description: Cannot view other player's match state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: Match not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /game/matches/{match_id}/move:
    post:
      summary: Submit a card move in match
      tags: [Game]
      operationId: submit_move
      security:
        - bearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player_id
                - card_index
              properties:
                player_id:
                  type: string
                  description: Player making the move (must match authenticated user)
                card_index:
                  type: integer
                  description: Index of card in player's hand (0-based)
      responses:
        "200":
          description: Move executed
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/MoveResultSchema'
                  - type: object
                    properties:
                      status:
                        type: string
                        example: "waiting_for_opponent"
        "400":
          description: Invalid move
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "403":
          description: Cannot submit move for other player
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: Match not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /game/matches/active:
    get:
      summary: Get all active matches for authenticated player
      tags: [Game]
      operationId: get_active_matches
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of active matches
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MatchStateResponse'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /game/matches/{match_id}/surrender:
    post:
      summary: Surrender the match
      tags: [Game]
      operationId: surrender_match
      security:
        - bearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Match surrendered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchStateResponse'
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: Match not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /cards:
    get:
      summary: Get deck gallery visualization (SVG)
      tags: [Game]
      operationId: get_deck_gallery
      description: Returns complete deck gallery as SVG showing all available cards in grid layout
      responses:
        "200":
          description: Deck gallery SVG
          content:
            image/svg+xml:
              schema:
                type: string
                format: binary

  /cards/{card_id}:
    get:
      summary: Get card detail visualization (SVG)
      tags: [Game]
      operationId: get_card_detail
      description: Returns detailed card view as SVG with all statistics
      parameters:
        - name: card_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Card detail SVG
          content:
            image/svg+xml:
              schema:
                type: string
                format: binary
        "404":
          description: Card not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /game/matches/{match_id}/hand:
    get:
      summary: Get player's hand visualization (SVG)
      tags: [Game]
      operationId: get_player_hand_visual
      description: Returns player's current hand in match as SVG, showing available and used cards
      security:
        - bearerAuth: []
      parameters:
        - name: match_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Player hand SVG
          content:
            image/svg+xml:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "404":
          description: Match or player not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /game/health:
    get:
      summary: Game service health check
      tags: [Game]
      operationId: game_health
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"

security:
  - bearerAuth: []

tags:
  - name: Auth
    description: User authentication and token management
  - name: Player
    description: Player profiles and match history
  - name: Game
    description: Game match creation and gameplay
